# Обновление версии {{ MY }}

Вы можете обновить кластер {{ mmy-name }} до любой поддерживаемой версии: минорной или мажорной.

В однохостовых кластерах на обновление выводится единственный хост-мастер. Во время обновления такие кластеры недоступны для чтения и записи, в отличие от кластеров из двух и более хостов. После возобновления работы СУБД потребуется время на «прогрев» буферного пула, что может временно повлиять на производительность запросов — это особенно заметно на больших базах данных с активным использованием индексов.

В многохостовых кластерах обновление проводится в следующем порядке:

1. Хосты-реплики последовательно выводятся на обновление и отключаются. Порядок реплик в очереди определяется случайным образом. После обновления реплики возвращаются в работу. На этом этапе возможно временное снижение производительности операций чтения, так как часть реплик будет недоступна.

1. Мастер закрывается на запись. Среди реплик [выбирается новый мастер](../concepts/replication.md#master-failover), который открывается для записи. В результате кластер обновляется с минимальным временем простоя.

1. Исходный мастер отключается, обновляется и возвращается в роли реплики. Обратно мастер не переключается, чтобы минимизировать риски дополнительных переключений.

{% note info %}

В {{ MY }} версии 8.0 переключение реплик происходит более надежно и эффективно благодаря улучшенной обработке метаданных.

{% endnote %}

Об обновлениях в рамках одной версии и обслуживании хостов см. в разделе [Техническое обслуживание](../concepts/maintenance.md).

{% note alert %}

* После обновления СУБД вернуть кластер к предыдущей версии невозможно.
* Обновляйте кластер в период низкой нагрузки на него — это снизит риски и уменьшит влияние на пользователей.
* Успешность обновления версии {{ MY }} зависит от многих факторов, например:

   * Настройки кластера и специфические конфигурации.
   * Особенности хранимых данных и их структуры.
   * Используемые возможности {{ MY }} (особенно JSON-функциональность и полнотекстовый поиск).
   * Совместимость приложений с новой версией.
   * Корректность хранимых процедур и триггеров.
   * Состояние текущей базы данных и качество данных.

   Рекомендуется сначала [обновить тестовый кластер](#before-update), который использует те же данные и настройки.

{% endnote %}

## Перед обновлением версии {#before-update}

При подготовке к обновлению особенно важен комплексный подход к тестированию и анализу совместимости. Наш опыт показывает, что большинство проблем при обновлении можно предотвратить на этапе подготовки:

1. Посмотрите в [истории изменений](https://docs.percona.com/percona-server/8.0/release-notes/release-notes_index.html) {{ MY }}, как обновления могут повлиять на работу ваших приложений.

   {% cut "Примеры изменений в {{ MY }} 8.0" %}

   * Изменения в поведении SQL-функций и оптимизатора запросов:

      ```sql
      -- Пример запроса для анализа плана выполнения
      EXPLAIN ANALYZE
      SELECT * FROM <имя_таблицы>
      WHERE complex_condition
      ORDER BY <поле>;
      ```

   * Устаревшие и удаленные возможности, особенно в области безопасности:

      ```sql
      -- Проверка механизмов аутентификации
      SELECT user, host, plugin 
      FROM mysql.user 
      WHERE user NOT LIKE 'mysql.%';
      ```

   * Изменения в работе полнотекстового поиска и обработке JSON:

      ```sql
      -- Проверка использования JSON-функций
      SELECT COUNT(*) 
      FROM information_schema.routines 
      WHERE routine_definition LIKE '%JSON%';
      ```

   * Новые значения по умолчанию для настроек СУБД.
   * Особенности работы с метаданными и временными таблицами.

   {% endcut %}

1. Попробуйте обновить версию на тестовом кластере.
   
   1. Разверните тестовый кластер из резервной копии основного кластера, используя окружение `PRESTABLE`, и обновите его до нужной версии.
   1. Проверьте работу критичных запросов и хранимых процедур.
   1. Проверьте функционал, использующий JSON и полнотекстовый поиск.
   1. Проведите нагрузочное тестирование:

      ```sql
      -- Мониторинг производительности во время тестов
      SELECT EVENT_NAME, COUNT_STAR, AVG_TIMER_WAIT
      FROM performance_schema.events_statements_summary_by_digest
      WHERE SCHEMA_NAME = '<имя_базы_данных>'
      ORDER BY AVG_TIMER_WAIT DESC
      LIMIT 10;
      ```

1. [Создайте резервную копию](cluster-backups.md) основного кластера непосредственно перед обновлением.

1. Обеспечьте отказоустойчивость кластера:
   
   1. Убедитесь, что в основном и тестовом кластере есть хотя бы два хоста-реплики и один хост-мастер. При необходимости [добавьте хосты](hosts.md#add).
   1. (Опционально) Проверьте состояние репликации и задержки:

     ```sql
     -- Проверка статуса репликации
     SHOW SLAVE STATUS\G

     -- Проверка задержек репликации
     SELECT
       SUBSTRING_INDEX(HOST, ':', 1) AS slave_host,
       SUBSTRING_INDEX(HOST, ':', -1) AS slave_port,
       SECONDS_BEHIND_MASTER,
       SLAVE_IO_RUNNING,
       SLAVE_SQL_RUNNING
     FROM information_schema.PROCESSLIST
     WHERE COMMAND = 'Binlog Dump';
     ```

## Обновить версию {{ MY }} {#start-update}

{% list tabs group=instructions %}

- Консоль управления {#console}

   1. Перейдите на страницу каталога и выберите сервис **{{ ui-key.yacloud.iam.folder.dashboard.label_managed-mysql }}**.
   1. Выберите нужный кластер в списке и нажмите кнопку ![image](../../_assets/pencil.svg) **{{ ui-key.yacloud.mdb.clusters.button_action-edit }}**.
   1. В поле **{{ ui-key.yacloud.mdb.forms.base_field_version }}** выберите номер новой версии.
   1. Нажмите кнопку **{{ ui-key.yacloud.mdb.forms.button_edit }}**.

   После запуска обновления кластер переходит в статус **Updating**. Дождитесь окончания операции и проверьте версию кластера.

   Время обновления зависит от многих факторов, например от объема данных или количества баз данных в кластере. Обновление обычно занимает несколько минут, для больших БД — от 10 минут.

- CLI {#cli}

   {% include [cli-install](../../_includes/cli-install.md) %}

   {% include [default-catalogue](../../_includes/default-catalogue.md) %}

   Чтобы обновить версию {{ MY }}:

   1. Получите список ваших кластеров {{ MY }} командой:

      ```bash
      {{ yc-mdb-my }} cluster list
      ```

   1. Получите информацию о нужном кластере и проверьте версию {{ MY }}, указанную в свойстве `config.version`:

      ```bash
      {{ yc-mdb-my }} cluster get <имя_или_идентификатор_кластера>
      ```

   1. Запустите обновление {{ MY }}:

      ```bash
      {{ yc-mdb-my }} cluster update <имя_или_идентификатор_кластера> \
         --mysql-version <номер_новой_версии>
      ```

   Время обновления зависит от многих факторов, например от объема данных или количества баз данных в кластере. Обновление обычно занимает несколько минут, для больших БД — от 10 минут.

- {{ TF }} {#tf}

   1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.

      О том, как создать такой файл, см. в разделе [Создание кластера](cluster-create.md).

   1. Добавьте поле `version` в ресурс `yandex_mdb_mysql_cluster` или измените значение поля, если оно уже существует:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя_кластера>" {
         ...
         version = "<версия_{{ MY }}>"
         ...
      }
      ```

   1. Проверьте корректность настроек.

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

   1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

   Подробнее см. в [документации провайдера {{ TF }}]({{ tf-provider-mmy }}).

   {% include [Terraform timeouts](../../_includes/mdb/mmy/terraform/timeouts.md) %}

- REST API {#api}

   1. [Получите IAM-токен для аутентификации в API](../api-ref/authentication.md) и поместите токен в переменную среды окружения:

      {% include [api-auth-token](../../_includes/mdb/api-auth-token.md) %}

   1. Воспользуйтесь методом [Cluster.update](../api-ref/Cluster/update.md) и выполните запрос, например, с помощью {{ api-examples.rest.tool }}:

      {% include [note-updatemask](../../_includes/note-api-updatemask.md) %}

      ```bash
      curl \
         --request PATCH \
         --header "Authorization: Bearer $IAM_TOKEN" \
         --header "Content-Type: application/json" \
         --url 'https://{{ api-host-mdb }}/managed-mysql/v1/clusters/<идентификатор_кластера>' \
         --data '{
                   "updateMask": "configSpec.version",
                   "configSpec": {
                     "version": "<версия_{{ MY }}>"
                   }
                 }'
      ```

      Где:

      * `updateMask` — перечень изменяемых параметров в одну строку через запятую.

         В данном случае передается только один параметр.

      * `configSpec.version` — новая версия {{ MY }}.

      Идентификатор кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

   1. Убедитесь, что запрос был выполнен успешно, изучив [ответ сервера](../api-ref/Cluster/update.md#yandex.cloud.operation.Operation).

- gRPC API {#grpc-api}

   1. [Получите IAM-токен для аутентификации в API](../api-ref/authentication.md) и поместите токен в переменную среды окружения:

      {% include [api-auth-token](../../_includes/mdb/api-auth-token.md) %}

   1. {% include [grpc-api-setup-repo](../../_includes/mdb/grpc-api-setup-repo.md) %}
   1. Воспользуйтесь вызовом [ClusterService/Update](../api-ref/grpc/Cluster/update.md) и выполните запрос, например, с помощью {{ api-examples.grpc.tool }}:

      {% include [note-grpc-updatemask](../../_includes/note-grpc-api-updatemask.md) %}

      ```bash
      grpcurl \
         -format json \
         -import-path ~/cloudapi/ \
         -import-path ~/cloudapi/third_party/googleapis/ \
         -proto ~/cloudapi/yandex/cloud/mdb/mysql/v1/cluster_service.proto \
         -rpc-header "Authorization: Bearer $IAM_TOKEN" \
         -d '{
               "cluster_id": "<идентификатор_кластера>",
               "update_mask": {
                 "paths": [
                   "config_spec.version"
                 ]
               },
               "config_spec": {
                 "version": "<версия_{{ MY }}>"
               }
             }' \
         {{ api-host-mdb }}:{{ port-https }} \
         yandex.cloud.mdb.mysql.v1.ClusterService.Update
      ```

      Где:

      * `update_mask` — перечень изменяемых параметров в виде массива строк `paths[]`.

         В данном случае передается только один параметр.

      * `config_spec.version` — новая версия {{ MY }}.

      Идентификатор кластера можно запросить со [списком кластеров в каталоге](cluster-list.md#list-clusters).

   1. Убедитесь, что запрос был выполнен успешно, изучив [ответ сервера](../api-ref/grpc/Cluster/create.md#yandex.cloud.operation.Operation).

{% endlist %}

Время обновления зависит от многих факторов, например от объема данных или количества баз данных в кластере. Обновление обычно занимает несколько минут, для больших БД — от 10 минут.

## Примеры {#examples}

Рассмотрим практический пример обновления кластера с версии 5.7 до 8.0. Этот сценарий особенно интересен, так как включает наиболее существенные изменения в архитектуре {{ MY }}.

{% list tabs group=instructions %}

- CLI {#cli}

   1. Получите список кластеров и узнайте их идентификаторы и имена:

      ```bash
      {{ yc-mdb-my }} cluster list
      ```

      Пример результата:

      ```text
      +----------------------+------------+---------------------+--------+---------+
      |          ID          |    NAME    |     CREATED AT      | HEALTH | STATUS  |
      +----------------------+------------+---------------------+--------+---------+
      | c9q8p8j2gaih******** |  mysql406  | 2021-10-23 12:44:17 | ALIVE  | RUNNING |
      +----------------------+------------+---------------------+--------+---------+
      ```

   1. Получите детальную информацию о конкретном кластере:

      ```bash
      {{ yc-mdb-my }} cluster get mysql406
      ```

      В выводе будет указана текущая версия {{ MY }}:

      ```text
        id: c9q8p8j2gaih********
        ...
        config:
          version: "5.7"
          ...
      ```

   1. Запустите процесс обновления до версии 8.0:

      ```bash
      {{ yc-mdb-my }} cluster update mysql406 --mysql-version 8.0
      ```

      После выполнения этой команды начнется процесс обновления, который может занять от нескольких минут до часа, в зависимости от размера базы данных и конфигурации кластера.

- {{ TF }} {#tf}

   1. Откройте актуальный конфигурационный файл {{ TF }} с планом инфраструктуры.
   1. В поле `version` в ресурсе `yandex_mdb_mysql_cluster` укажите значение `8.0`:

      ```hcl
      resource "yandex_mdb_mysql_cluster" "<имя_кластера>" {
         ...
         version = "8.0"
         ...
      }
      ```

   1. Проверьте корректность настроек:

      {% include [terraform-validate](../../_includes/mdb/terraform/validate.md) %}

   1. Примените изменения:

      {% include [terraform-apply](../../_includes/mdb/terraform/apply.md) %}

   {{ TF }} автоматически определит необходимость обновления версии и запустит процесс.

{% endlist %}

После успешного обновления:

1. Проверьте статус всех критичных компонентов:

   ```sql
   -- Проверка статуса InnoDB
   SHOW ENGINE INNODB STATUS\G

   -- Проверка состояния репликации
   SHOW SLAVE STATUS\G
   ```

1. Убедитесь в корректности работы приложений:

   * Проверьте время выполнения критичных запросов.
   * Проконтролируйте статистику ошибок.
   * Отследите использование ресурсов.

1. Проведите оптимизацию конфигурации под новую версию:

   ```sql
   -- Анализ использования буферного пула
   SELECT POOL_ID, POOL_SIZE, FREE_BUFFERS, DATABASE_PAGES
   FROM information_schema.INNODB_BUFFER_POOL_STATS;
   
   -- Проверка настроек производительности
   SHOW VARIABLES LIKE '%buffer%';
   ```

## См. также {#see-also}

* [Технический обзор особенностей {{ MY }} 8.0](../concepts/mysql-57-80-comparison.md), рассматривающий изменения в производительности и функциональности новой версии.
