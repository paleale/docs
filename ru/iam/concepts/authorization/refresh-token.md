# Refresh-токен

_Refresh-токен_ — это тип учетных данных, позволяющий OAuth-приложению при истечении срока действия [IAM-токена](./iam-token.md) пользователя автоматически получать новый IAM-токен. Refresh-токен выпускается для пользователя и передается в OAuth-приложение, которое выполняет аутентификацию пользователя в {{ yandex-cloud }}.

Одним из OAuth-приложений, поддерживающих использование refresh-токенов, является [{{ yandex-cloud }} CLI](../../../cli/index.yaml). При этом refresh-токены могут выпускаться только для [федеративных](../../../organization/concepts/add-federation.md) пользователей [организации {{ org-full-name }}](../../../overview/roles-and-resources.md).

С помощью {{ yandex-cloud }} CLI и [API](../../api-ref/RefreshToken/index.md) вы можете [просматривать](../../operations/refresh-token/list.md) список выпущенных для пользователя refresh-токенов и [отзывать](../../operations/refresh-token/revoke.md) такие токены.

## Срок жизни refresh-токенов {#token-lifetime}

Срок жизни refresh-токена составляет 31 день. Refresh-токен автоматически перевыпускается при его использовании для получения IAM-токена, если до окончания срока действия refresh-токена остается менее семи дней.

Если срок действия refresh-токена истек, необходимо получить новый refresh-токен. Новый refresh-токен будет создан автоматически при следующем получении IAM-токена. При этом пользователю придется повторно выполнить аутентификацию в браузере. 

Refresh-токены автоматически удаляются через семь дней после истечения срока их действия.

## Включение возможности использования refresh-токенов в {{ yandex-cloud }} CLI {#token-enabling}

Чтобы использовать refresh-токены в {{ yandex-cloud }} CLI, эту функциональность необходимо включить на уровне организации {{ org-name }}. Для этого:

{% include [enable-refresh-tokens](../../../_includes/organization/enable-refresh-tokens.md) %}

## Защита refresh-токенов с помощью DPoP в {{ yandex-cloud }} CLI {#dpop-verification}

Чтобы подтвердить подлинность запроса на получение IAM-токена с помощью refresh-токена, используется механизм [DPoP](https://datatracker.ietf.org/doc/html/rfc9449). Верификация выполняется с помощью специального DPoP-ключа, который создается на стороне пользовательского устройства и позволяет подтвердить подлинность пользователя, выполняющего запрос, и устройства, с которого этот запрос выполняется.

Если опция **Разрешить хранение DPoP-ключей только на устройствах YubiKey** в настройках организации [отключена](#token-enabling), для защиты refresh-токенов можно будет использовать DPoP-ключи, сохраненные как на устройстве YubiKey, так и в файловой системе на компьютере пользователя (менее безопасно).

Включите опцию **Разрешить хранение DPoP-ключей только на устройствах YubiKey**, чтобы повысить степень защиты refresh-токенов и оставить возможность использовать только DPoP-ключи, сохраненные на специализированном устройстве YubiKey, которое обеспечивает неизвлекаемость ключей.

### Инициализация DPoP-защиты refresh-токенов в {{ yandex-cloud }} CLI {#enabling-dpop}

DPoP-ключ, подтверждающий подлинность пользователя и устройства, которые отправляют запрос на получение IAM-токена, должен быть создан на стороне пользовательского устройства. Механизм создания, хранения и использования такого DPoP-ключа должен быть реализован внутри OAuth-приложения, использующего refresh-токены.

Чтобы инициализировать DPoP-защиту refresh-токенов федеративного пользователя в {{ yandex-cloud }} CLI:

1. Убедитесь, что на уровне вашей организации {{ org-name }} [включена](#token-enabling) возможность использования refresh-токенов.
1. Инициализируйте DPoP-защиту refresh-токенов на устройстве пользователя:

    {% list tabs group=instructions %}

    - {{ yandex-cloud }} CLI {#cli}

      1. [Создайте](../../../cli/operations/authentication/federated-user.md) профиль CLI федеративного пользователя и аутентифицируйтесь от его имени в {{ yandex-cloud }}.
      1. Запустите инициализацию DPoP-защиты:

          ```bash
          yc init --dpop
          ```

          {{ yandex-cloud }} CLI предложит вам пройти процедуру конфигурации DPoP-защиты:
          
          ```text
          Welcome! This command will take you through the configuration process.
          Do you want to initialize file system auth keys? [y/N]
          ```
      1. Пройдите процедуру конфигурации. Для этого введите `y` и нажмите `ENTER`.

          Следуйте инструкциям конфигуратора, чтобы сгенерировать и сохранить DPoP-ключ в файловой системе компьютера или на устройстве YubiKey.

    {% endlist %}

После выполнения инициализации при следующем получении нового IAM-токена для пользователя будет создан refresh-токен. В дальнейшем {{ yandex-cloud }} CLI станет самостоятельно обновлять IAM-токены данного федеративного пользователя без необходимости регулярно выполнять аутентификацию в браузере.

При хранении DPoP-ключа в файловой системе IAM-токен перевыпускается сразу. При использовании устройства YubiKey перевыпуск IAM-токена выполняется только после подтверждения действия на устройстве YubiKey.