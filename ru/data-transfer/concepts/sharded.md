# Параллельное копирование

Сервис {{ data-transfer-name }} может одновременно задействовать для трансфера несколько потоков исполнения. Это существенно увеличивает пропускную способность трансфера и позволяет использовать для него больший объем ресурсов. Параллельное копирование применяется для [всех видов копирования](transfer-lifecycle.md#copy) в трансферах типа _{{ dt-type-copy }}_ и _{{ dt-type-copy-repl }}_, находящихся в [статусе](transfer-lifecycle.md#statuses) {{ dt-status-copy }}.

Чтобы включить параллельное копирование, укажите его [настройки](#settings). Настройки параллельного копирования рекомендуется подбирать для каждого трансфера отдельно.

## Источники, которые поддерживают параллельное копирование одной таблицы {#source-databases}

Возможности масштабирования зависят от типа базы-источника:

* Источники [{{ PG }}](../operations/endpoint/source/postgresql.md), [{{ MG }}](../operations/endpoint/source/mongodb.md) и [{{ GP }}](../operations/endpoint/source/greenplum.md) поддерживают разделение таблиц на части и параллельное копирование данных из одной таблицы. Для {{ PG }} первичный ключ должен быть типа `serial`.
* Источники [{{ OS }}](../operations/endpoint/source/opensearch.md) и [{{ ES }}](../operations/endpoint/source/elasticsearch.md) поддерживают параллельное копирование данных из одного индекса.
* Источники [{{ CH }}](../operations/endpoint/source/clickhouse.md) поддерживают параллельное копирование по партициям. Для этого таблица должна иметь несколько партиций. Таблица из одной партиции будет скопирована в один поток. Параллельное копирование доступно только для трансферов из {{ CH }} в {{ CH }}.
* Источник [{{ objstorage-full-name }}](../operations/endpoint/source/object-storage.md) поддерживает параллельное копирование данных из одного каталога.

Прочие источники поддерживают параллельное копирование нескольких таблиц одновременно (без распараллеливания внутри одной таблицы).

## Особенности параллельного копирования {{ GP }} {#special-gp}

Сервис подключается напрямую к сегментам кластера {{ GP }} и переносит данные из выбранной таблицы параллельно из всех сегментов. Консистентность данных в каждом сегменте обеспечивается механизмом [Snapshot isolation]({{ pg-docs }}/transaction-iso.html#XACT-REPEATABLE-READ).

## Настройки {#settings}

{% list tabs group=instructions %}

- Консоль управления {#console}


  **{{ ui-key.yc-data-transfer.data-transfer.console.form.transfer.console.form.transfer.TransferTypeRegularSnapshot.snapshot_settings.title }}** → **{{ ui-key.yc-data-transfer.data-transfer.console.form.transfer.console.form.transfer.SnapshotSettings.parallel_settings.title }}**:

  * **{{ ui-key.yc-data-transfer.data-transfer.console.form.transfer.console.form.transfer.ParallelSnapshotSettings.workers_count.title }}** — количество [воркеров](index.md#worker), которые будут параллельно запущены для копирования данных. Каждый воркер запускается на независимой виртуальной машине с собственными ресурсами CPU и RAM и собственным сетевым подключением.

  * **{{ ui-key.yc-data-transfer.data-transfer.console.form.transfer.console.form.transfer.ParallelSnapshotSettings.threads_count.title }}** — количество потоков, которое будет запущено в каждом воркере. Каждый поток запускается в отдельном контейнере на виртуальной машине воркера и копирует одну таблицу или ее часть (в зависимости от типа источника).

  Подробнее о настройке воркеров и потоков см. в [рекомендациях](#recommendations).


{% endlist %}

## Рекомендации по параллельному копированию {#recommendations}

Убедитесь, что для вашего трансфера есть [настройки](#settings) параллельного копирования.

Параллельное копирование помогает ускорить перенос данных, только если скорость трансфера достаточная. Она зависит от следующих факторов:

* скорость чтения из базы-источника;
* скорость обработки данных сервисом {{ data-transfer-name }};
* скорость вставки данных в базу-приемник.

Чтобы проверить скорость трансфера, посмотрите графики сервиса [{{ monitoring-full-name }}](../../monitoring/). Скорость считается достаточной, если выполняются условия:

* На графиках кластера-источника и кластера-приемника потребление таких ресурсов, как CPU, RAM или объем диска, не приближается к предельным значениям.

* График трансфера «Target response time [s]» показывает, что 95% записей выполняются быстрее, чем за секунду.

    Для {{ CH }}-приемника скорость приема данных регулируется [настройкой эндпоинта-приемника](../operations/endpoint/target/clickhouse.md#additional-settings) **{{ ui-key.yc-data-transfer.data-transfer.console.form.clickhouse.console.form.clickhouse.ClickHouseTargetAdvancedSettings.flush_interval.title }}**. Значение может превышать 1 секунду. В таком случае график трансфера «Target response time [s]» должен показывать, что 95% записей выполняются быстрее, чем время, указанное в настройке **{{ ui-key.yc-data-transfer.data-transfer.console.form.clickhouse.console.form.clickhouse.ClickHouseTargetAdvancedSettings.flush_interval.title }}**.

При параллельном копировании вы выбираете количество воркеров и количество потоков в воркере. Чем выше будут значения, тем больше будут производительность трансфера, количество сетевых соединений и нагрузка трансфера на источник и приемник. Эти показатели увеличиваются пропорционально числу воркеров, умноженному на число потоков внутри воркера.

Чтобы добиться оптимальной производительности и нагрузки, проверьте работу трансфера при разных настройках параллельного копирования. В качестве начальных значений используйте 2 воркера и 4 потока внутри воркера. Они ускоряют копирование примерно в 8 раз. Дальше следите за трансфером и следуйте рекомендациям:

* Если скорость копирования недостаточная и у источника и приемника есть свободные ресурсы, увеличьте количество воркеров. Проверить скорость копирования можно на графике трансфера «Target response time [s]», наличие свободных ресурсов — на графиках потребления ресурсов в кластерах.

* Если наблюдается недопустимо высокая нагрузка на источник или приемник, то остановите копирование, уменьшите количество воркеров и запустите трансфер снова. Проверить нагрузку можно на графиках потребления ресурсов в кластерах.

* Если существенно увеличилось время записи в приемник, то остановите копирование, уменьшите количество воркеров и запустите трансфер снова. Проверить скорость записи можно на графике трансфера «Target response time [s]».

* Если появляется ошибка вида `Instance was restarted`, уменьшите количество потоков внутри воркера и запустите трансфер снова.

Если возникают сложности с настройкой, обратитесь в [техническую поддержку]({{ link-console-support }}).

{% include [greenplum-trademark](../../_includes/mdb/mgp/trademark.md) %}